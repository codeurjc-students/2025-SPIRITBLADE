<main class="dashboard-container">
	<section class="user-profile">
		<div class="profile-header">
			<div class="user-avatar">
				<div class="avatar-placeholder" [class.has-avatar]="avatarUrl">
					<!-- Avatar Image -->
					<img 
						*ngIf="avatarUrl" 
						[src]="avatarUrl" 
						alt="User Avatar" 
						class="avatar-image"
						(load)="onAvatarLoad()"
						(error)="onAvatarError($event)"
					/>
					<div *ngIf="!avatarUrl" class="default-avatar-icon">ðŸ‘¤</div>
					<div *ngIf="avatarUploading" class="avatar-loading">
						<span>Uploading...</span>
					</div>
				</div>
				<button class="edit-avatar-btn" (click)="openAvatarPicker()" [disabled]="avatarUploading">
					{{ avatarUploading ? 'Uploading...' : 'Edit' }}
				</button>
				<div *ngIf="avatarError" class="avatar-error">{{ avatarError }}</div>
			</div>
			<div class="user-info">
				<h1>Welcome, {{ stats?.username || 'Guest' }}</h1>
				
				<!-- Show linked account info or link button -->
				<div *ngIf="linkedSummonerLoading" class="loading-text">Loading account info...</div>
				<div *ngIf="!linkedSummonerLoading && linkedSummoner" class="linked-account-info">
					<p class="linked-label">Linked Account:</p>
					<a [routerLink]="['/summoner', linkedSummoner.name]"><p class="linked-summoner">{{ linkedSummoner.name }} ({{ linkedSummoner.region }})</p></a>
					<button class="unlink-btn" (click)="unlinkAccount()">Unlink Account</button>
				</div>
				<div *ngIf="!linkedSummonerLoading && !linkedSummoner">
					<p class="no-linked-account">No linked account</p>
					<button class="link-account-btn" (click)="openLinkModal()">Link LoL Account</button>
				</div>
			</div>
		</div>
	</section>

	<section class="favorites">
		<h2>Favorite Summoners</h2>
		<div *ngIf="favoritesLoading">Loading favorites...</div>
		<div *ngIf="favoritesError" class="error">{{ favoritesError }}</div>
		<div class="favorites-list" *ngIf="!favoritesLoading && !favoritesError">
			<div class="favorite-card" *ngFor="let f of favorites">
				<a [routerLink]="['/summoner', f.name]" class="summoner-name">{{ f.name }}</a>
				<span class="summoner-rank">{{ f.tier || 'Unranked' }} {{ f.rank || '' }}</span>
				<button class="remove-btn" (click)="removeFavorite(f.name)">Remove</button>
			</div>
			<button class="add-favorite-btn" (click)="openAddFavoriteModal()">+ Add Favorite</button>
		</div>
	</section>

	<!-- Add Favorite Modal -->
	<div class="modal-overlay" *ngIf="showAddFavoriteModal" (click)="closeAddFavoriteModal()" (keydown.escape)="closeAddFavoriteModal()">
		<div class="modal-content" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
			<h3>Add Favorite Summoner</h3>
			<div class="form-group">
				<label for="favoriteName">Summoner:</label>
				<input 
					type="text" 
					id="favoriteName" 
					[(ngModel)]="addFavoriteName" 
					[disabled]="addFavoriteLoading">
				<small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
					Enter the summoner name followed by #region (e.g., Player#EUW1)
				</small>
			</div>
			<div class="error" *ngIf="addFavoriteError">{{ addFavoriteError }}</div>
			<div class="modal-actions">
				<button 
					class="btn-primary" 
					(click)="addFavorite()" 
					[disabled]="addFavoriteLoading || !addFavoriteName">
					{{ addFavoriteLoading ? 'Adding...' : 'Add Favorite' }}
				</button>
				<button class="btn-secondary" (click)="closeAddFavoriteModal()" [disabled]="addFavoriteLoading">Cancel</button>
			</div>
		</div>
	</div>

	<section class="personal-stats">
		<div class="stats-header">
			<h2>Your Performance</h2>
			<button 
				*ngIf="linkedSummoner" 
				class="ai-analysis-btn" 
				(click)="openAiAnalysisModal()"
				title="Get AI-powered performance analysis">
				Analyze with AI
			</button>
		</div>
		<div *ngIf="loading">Loading stats...</div>
		<div *ngIf="error" class="error">{{ error }}</div>
		<div *ngIf="stats" class="stats-grid">
			<div class="stat-card">
				<h3>Current Rank</h3>
				<p class="stat-number">{{ stats.currentRank || 'Unranked' }}</p>
			</div>
			<div class="stat-card">
				<h3>LP Gained (7 days)</h3>
				<p class="stat-number">{{ stats.lp7days !== undefined ? stats.lp7days : '0' }}</p>
			</div>
			<div class="stat-card">
				<h3>Main Role</h3>
				<p class="stat-number">{{ stats.mainRole || 'Unknown' }}</p>
			</div>
			<div class="stat-card">
				<h3>Favorite Champion</h3>
				<p class="stat-number">{{ stats.favoriteChampion || 'N/A' }}</p>
			</div>
		</div>
		
		<!-- LP Progression Chart - Only shown when account is linked -->
		<div class="chart-container" *ngIf="linkedSummoner">
			<div class="chart-header">
				<h3>Match History & Win Rate Progression</h3>
				<div class="queue-toggle">
					<button 
						class="toggle-btn" 
						[class.active]="selectedQueue === 420"
						(click)="onQueueChange(420)"
						[disabled]="chartLoading || matchesLoading">
						Solo/Duo
					</button>
					<button 
						class="toggle-btn" 
						[class.active]="selectedQueue === 440"
						(click)="onQueueChange(440)"
						[disabled]="chartLoading || matchesLoading">
						Flex
					</button>
				</div>
			</div>
			<div *ngIf="chartLoading" class="chart-loading">
				<p>Loading match history...</p>
			</div>
			<div *ngIf="chartError" class="chart-error">
				<p>{{ chartError }}</p>
			</div>
			<div class="chart-wrapper" [style.display]="rankedMatches.length > 0 ? 'block' : 'none'">
				<canvas #lpChartCanvas></canvas>
			</div>
			<div *ngIf="!chartLoading && !chartError && rankedMatches.length === 0" class="chart-empty">
				<p>No ranked matches available. Play some ranked games to see your progression!</p>
			</div>
		</div>

		<!-- Message when no account is linked -->
		<div class="no-linked-chart-message" *ngIf="!linkedSummoner && !linkedSummonerLoading">
			<p>Link your League of Legends account to see your LP progression chart</p>
		</div>
	</section>
</main>

<!-- Link Account Modal -->
<div class="modal-overlay" *ngIf="showLinkModal" (click)="closeLinkModal()" (keydown.escape)="closeLinkModal()">
	<div class="modal-content" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
		<div class="modal-header">
			<h2>Link League of Legends Account</h2>
			<button class="close-btn" (click)="closeLinkModal()">&times;</button>
		</div>
		
		<div class="modal-body">
			<div class="form-group">
				<label for="summonerName">Summoner Name#Region</label>
				<input 
					type="text" 
					id="summonerName" 
					[(ngModel)]="summonerName" 
					placeholder="e.g., Player#EUW1"
					[disabled]="linkLoading"
				/>
				<small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
					Enter your summoner name followed by #region (e.g., Player#EUW1)
				</small>
			</div>
			
			<div *ngIf="linkError" class="error-message">
				{{ linkError }}
			</div>
			
			<div *ngIf="linkSuccess" class="success-message">
				{{ linkSuccess }}
			</div>
		</div>
		
		<div class="modal-footer">
			<button class="cancel-btn" (click)="closeLinkModal()" [disabled]="linkLoading">
				Cancel
			</button>
			<button class="submit-btn" (click)="submitLinkAccount()" [disabled]="linkLoading">
				<span *ngIf="!linkLoading">Link Account</span>
				<span *ngIf="linkLoading">Linking...</span>
			</button>
		</div>
	</div>
</div>

<!-- AI Analysis Modal -->
<div class="modal-overlay" *ngIf="showAiModal" (click)="closeAiAnalysisModal()" (keydown.escape)="closeAiAnalysisModal()">
	<div class="modal-content ai-modal" [class.ai-has-result]="aiAnalysis && !aiAnalysisLoading" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
		<div class="modal-header">
			<h2>AI Analysis</h2>
			<button class="close-btn" (click)="closeAiAnalysisModal()">&times;</button>
		</div>
		
		<div class="modal-body">
			<!-- Configuration Section -->
			<div class="ai-config" *ngIf="!aiAnalysis && !aiAnalysisLoading">
				<div class="form-group" style="margin-bottom: 1rem;">
					<label for="matchCount">Number of Matches:</label>
					<input 
						type="number" 
						id="matchCount" 
						[(ngModel)]="aiMatchCount" 
						min="10" 
						max="10"
						placeholder="10"
					/>
				</div>
				<small style="color: var(--text-secondary)">Due to rate limits only 10 matches are analyzed</small>
				<div style="margin-top: 20px;">
					<button class="btn-primary generate-btn" (click)="generateAiAnalysis()">
						Generate Analysis
					</button>
				</div>
			</div>
			
			<!-- Loading State -->
			<div class="ai-loading" *ngIf="aiAnalysisLoading">
				<div class="spinner"></div>
				<p>Analyzing your last {{ aiMatchCount }} matches...</p>
				<p class="loading-subtitle">This may take a few seconds</p>
			</div>
			
			<!-- Error State -->
			<div *ngIf="aiAnalysisError" class="error-message">
				{{ aiAnalysisError }}
			</div>
			
			<!-- Analysis Result -->
			<div class="ai-result" *ngIf="aiAnalysis && !aiAnalysisLoading">
				<div class="analysis-meta">
					<p><strong>Matches Analyzed:</strong> {{ aiMatchesAnalyzed }}</p>
					<p><strong>Generated:</strong> {{ aiGeneratedAt | date:'short' }}</p>
				</div>
				<div class="analysis-content" [innerHTML]="aiAnalysis | markdownToHtml"></div>
			</div>
		</div>
		
		<div class="modal-footer" *ngIf="!aiAnalysisLoading">
			<button class="cancel-btn" (click)="closeAiAnalysisModal()">
				Close
			</button>
		</div>
	</div>
</div>
