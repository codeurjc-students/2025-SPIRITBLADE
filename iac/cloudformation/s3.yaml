AWSTemplateFormatVersion: '2010-09-09'
Description: 'SPIRITBLADE S3 Bucket for Object Storage'

Parameters:
  EnvironmentName:
    Type: String
    Default: spiritblade-dev
    Description: Environment name
  BucketName:
    Type: String
    Description: Unique name for the S3 bucket (leave empty for auto-generated)

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If [HasBucketName, !Ref BucketName, !Ref AWS::NoValue]
      AccessControl: Private
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
            AllowedOrigins: ['*'] # Restrict this in production to your domain
            MaxAge: 3000

Conditions:
  HasBucketName: !Not [!Equals [!Ref BucketName, '']]

Outputs:
  BucketName:
    Description: S3 Bucket Name
    Value: !Ref S3Bucket
    Export:
      Name: !Sub ${EnvironmentName}-S3BucketName
  BucketArn:
    Description: S3 Bucket ARN
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub ${EnvironmentName}-S3BucketArn
